before_script:
    #pre-installation script
    - cd ..
    - shopt -s extglob
    - rm -rf !(ILCDIRAC)
    - rm -rf .installCache
    - mv ILCDIRAC ILCDIRAC_commit
    - wget -O dirac-install -np  https://raw.github.com/DIRACGrid/DIRAC/master/Core/scripts/dirac-install.py  --no-check-certificate
    - chmod +x dirac-install
    - ./dirac-install -V ILCDIRAC -r v25r0p0
    - rm -rf DIRAC
    - mkdir DIRAC
    - cd DIRAC
    - git clone https://github.com/DIRACGrid/DIRAC.git .
    - git checkout origin/rel-v6r14
    - cd ..
    - rm -rf ILCDIRAC
    - mv ILCDIRAC_commit ILCDIRAC
    - source bashrc
    - dirac-deploy-scripts
    - pip install --upgrade pip pylint mock MySQL-python #coverage Check if we need coverage
    - easy_install pytest-cov
    - cd ILCDIRAC
    - export HOME=/root/


stages:
    - unit5
    - unit6
    - unit7
    - pylint5
    - pylint6
    - pylint7
    - cvmfs
#    - setests


pylint5:
  stage: pylint5
  tags:
    - docker
  image: ilcdirac/slc5-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-pylint.sh

unittest5:
  stage: unit5
  tags:
    - docker
  image: ilcdirac/slc5-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-unittests.sh

pylint6:
  stage: pylint6
  tags:
    - docker
  image: ilcdirac/slc6-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-pylint.sh

unittest6:
  stage: unit6
  tags:
    - docker
  image: ilcdirac/slc6-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-unittests.sh

cvmfstests6:
  stage: cvmfs
  tags:
    - docker
  image: ilcdirac/slc6-extra
  script:
    - yum -y install which fontconfig libpng
    - source ../bashrc
    - dirac-proxy-init -x <<< $CERT_PASSPHRASE
    - dirac-configure -S ILC-Production -C dips://voilcdirac012.cern.ch:9135/Configuration/Server --SkipCAChecks
    - echo "mysql:x:0:0:MySQL Server:/var/lib/mysql:/bin/bash" >> /etc/passwd
    - .gitlab-ci.d/run-cvmfstests.sh

pylint7:
  stage: pylint7
  tags:
    - docker
  image: ilcdirac/cc7-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-pylint.sh

unittest7:
  stage: unit7
  tags:
    - docker
  image: ilcdirac/cc7-base
  script:
    - source ../bashrc
    - .gitlab-ci.d/run-unittests.sh


#setests6:
#  stage: setests
#  tags:
#    - docker
#  image: ilcdirac/slc6-base
#  script:
#    - source ../bashrc
#    - dirac-proxy-init -x <<< $CERT_PASSPHRASE
#    - dirac-configure -S ILC-Production -C dips://voilcdirac012.cern.ch:9135/Configuration/Server --SkipCAChecks
#    - dirac-proxy-init <<< $CERT_PASSPHRASE
#    - .gitlab-ci.d/run-setests.sh
